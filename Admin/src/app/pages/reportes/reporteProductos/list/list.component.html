<div class="container-fluid">
  <!-- Overlay de carga -->
  <div *ngIf="mostrarOverlayCarga" class="overlay-carga">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <!-- Alerta de error -->
  <div *ngIf="mostrarAlertaError" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-triangle"></i>
    {{ mensajeError }}
    <button type="button" class="btn-close" (click)="mostrarAlertaError = false"></button>
  </div>

  <!-- Filtros -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">
            <i class="fas fa-filter"></i> Filtros de Búsqueda
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <label for="fechaInicio" class="form-label">Fecha Inicio</label>
              <input 
                type="date" 
                id="fechaInicio" 
                class="form-control" 
                [(ngModel)]="filtros.fechaInicio">
            </div>
            <div class="col-md-3">
              <label for="fechaFin" class="form-label">Fecha Fin</label>
              <input 
                type="date" 
                id="fechaFin" 
                class="form-control" 
                [(ngModel)]="filtros.fechaFin">
            </div>
            <div class="col-md-3">
              <label for="marca" class="form-label">Marca</label>
              <select 
                id="marca" 
                class="form-select" 
                [(ngModel)]="filtros.marcaId">
                <option [value]="null">Todas las marcas</option>
                <option *ngFor="let marca of marcas" [value]="marca.marc_Id">
                  {{ marca.marc_Descripcion }}
                </option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="categoria" class="form-label">Categoría</label>
              <select 
                id="categoria" 
                class="form-select" 
                [(ngModel)]="filtros.categoriaId">
                <option [value]="null">Todas las categorías</option>
                <option *ngFor="let categoria of categorias" [value]="categoria.cate_Id">
                  {{ categoria.cate_Descripcion }}
                </option>
              </select>
            </div>
          </div>
          
          <!-- Botones de acción -->
          <div class="row mt-3">
            <div class="col-12">
              <button 
                type="button" 
                class="btn btn-primary me-2" 
                (click)="generarReporte()"
                [disabled]="mostrarOverlayCarga">
                <i class="fas fa-search" *ngIf="!mostrarOverlayCarga"></i>
                <span class="spinner-border spinner-border-sm me-1" *ngIf="mostrarOverlayCarga"></span>
                {{ mostrarOverlayCarga ? 'Generando...' : 'Generar Reporte' }}
              </button>
              <button 
                type="button" 
                class="btn btn-secondary me-2" 
                (click)="limpiarFiltros()">
                <i class="fas fa-broom"></i> Limpiar Filtros
              </button>
              <button 
                type="button" 
                class="btn btn-success" 
                (click)="exportarPDF()" 
                [disabled]="productos.length === 0 || cargandoPDF">
                <i class="fas fa-file-pdf" *ngIf="!cargandoPDF"></i>
                <span class="spinner-border spinner-border-sm me-1" *ngIf="cargandoPDF"></span>
                {{ cargandoPDF ? 'Exportando...' : 'Exportar PDF' }}
              </button>
            </div>
          </div>

          <!-- Información de filtros aplicados -->
          <div class="row mt-3" *ngIf="hayFiltrosAplicados()">
            <div class="col-12">
              <div class="alert alert-info">
                <h6 class="alert-heading">
                  <i class="fas fa-info-circle"></i> Filtros aplicados:
                </h6>
                <ul class="mb-0">
                  <li *ngIf="filtros.fechaInicio">
                    <strong>Fecha inicio:</strong> {{ filtros.fechaInicio | date:'dd/MM/yyyy' }}
                  </li>
                  <li *ngIf="filtros.fechaFin">
                    <strong>Fecha fin:</strong> {{ filtros.fechaFin | date:'dd/MM/yyyy' }}
                  </li>
                  <li *ngIf="filtros.marcaId">
                    <strong>Marca:</strong> {{ getMarcaDescripcion(filtros.marcaId) }}
                  </li>
                  <li *ngIf="filtros.categoriaId">
                    <strong>Categoría:</strong> {{ getCategoriaDescripcion(filtros.categoriaId) }}
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reporte -->
  <div *ngIf="productos.length > 0" class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-chart-bar"></i> Reporte de Productos
          </h5>
          <span class="badge bg-light text-dark fs-6">
            Total: {{ productos.length }} producto{{ productos.length !== 1 ? 's' : '' }}
          </span>
        </div>
        <div class="card-body" id="reporteContent">
          <!-- Encabezado de la empresa (solo para vista previa) -->
          <div class="text-center mb-4 d-print-block d-none" *ngIf="configuracionEmpresa">
            <div class="row">
              <div class="col-2">
                <img 
                  *ngIf="configuracionEmpresa.coFa_Logo" 
                  [src]="configuracionEmpresa.coFa_Logo" 
                  alt="Logo" 
                  class="img-fluid" 
                  style="max-height: 80px;">
              </div>
              <div class="col-8">
                <h3 class="mb-1">{{ configuracionEmpresa.coFa_NombreEmpresa }}</h3>
                <p class="mb-1">
                  <strong>RTN:</strong> {{ configuracionEmpresa.coFa_RTN }}
                </p>
                <p class="mb-1">
                  <strong>Dirección:</strong> 
                  {{ configuracionEmpresa.coFa_DireccionEmpresa }}, 
                  {{ getDireccionCompleta() }}
                </p>
                <p class="mb-1">
                  <strong>Teléfonos:</strong> 
                  {{ configuracionEmpresa.coFa_Telefono1 }}
                  <span *ngIf="configuracionEmpresa.coFa_Telefono2"> / {{ configuracionEmpresa.coFa_Telefono2 }}</span>
                </p>
                <p class="mb-1">
                  <strong>Correo:</strong> {{ configuracionEmpresa.coFa_Correo }}
                </p>
              </div>
              <div class="col-2"></div>
            </div>
            <hr>
            <h4>REPORTE DE PRODUCTOS</h4>
            <p class="mb-3">
              <strong>Fecha de generación:</strong> {{ fechaGeneracion | date:'dd/MM/yyyy HH:mm' }}
            </p>
          </div>

          <!-- Información resumida -->
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">
                    <i class="fas fa-calendar"></i> Fecha de generación
                  </h6>
                  <p class="card-text">{{ fechaGeneracion | date:'dd/MM/yyyy HH:mm' }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">
                    <i class="fas fa-boxes"></i> Total de productos
                  </h6>
                  <p class="card-text">{{ productos.length }} productos encontrados</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabla de productos -->
          <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
              <thead class="table-dark">
                <tr>
                  <th class="text-center">#</th>
                  <th>Código</th>
                  <th>Código Barra</th>
                  <th>Descripción</th>
                  <th>Marca</th>
                  <th>Categoría</th>
                  <th class="text-end">Precio</th>
                  <th class="text-end">Costo</th>
                  <th class="text-center">Impuesto</th>
                  <th>Proveedor</th>
                  <th class="text-center">Fecha Creación</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let producto of productos; let i = index">
                  <td class="text-center">{{ producto.secuencia }}</td>
                  <td>
                    <strong>{{ producto.prod_Codigo }}</strong>
                  </td>
                  <td>
                    <span class="badge bg-secondary" *ngIf="producto.prod_CodigoBarra; else sinCodigo">
                      {{ producto.prod_CodigoBarra }}
                    </span>
                    <ng-template #sinCodigo>
                      <span class="text-muted">N/A</span>
                    </ng-template>
                  </td>
                  <td>
                    <div class="d-flex flex-column">
                      <strong>{{ producto.prod_Descripcion }}</strong>
                      <small class="text-muted" *ngIf="producto.prod_DescripcionCorta">
                        {{ producto.prod_DescripcionCorta }}
                      </small>
                    </div>
                  </td>
                  <td>
                    <span class="badge bg-info" *ngIf="producto.marc_Descripcion; else sinMarca">
                      {{ producto.marc_Descripcion }}
                    </span>
                    <ng-template #sinMarca>
                      <span class="text-muted">N/A</span>
                    </ng-template>
                  </td>
                  <td>
                    <span class="badge bg-warning text-dark" *ngIf="producto.cate_Descripcion; else sinCategoria">
                      {{ producto.cate_Descripcion }}
                    </span>
                    <ng-template #sinCategoria>
                      <span class="text-muted">N/A</span>
                    </ng-template>
                  </td>
                  <td class="text-end">
                    <strong class="text-success">
                      {{ producto.prod_PrecioUnitario | currency:'HNL':'symbol':'1.2-2' }}
                    </strong>
                  </td>
                  <td class="text-end">
                    <span class="text-danger">
                      {{ producto.prod_CostoTotal | currency:'HNL':'symbol':'1.2-2' }}
                    </span>
                  </td>
                  <td class="text-center">
                    <span 
                      class="badge" 
                      [class.bg-success]="producto.prod_PagaImpuesto === 'Si'"
                      [class.bg-secondary]="producto.prod_PagaImpuesto === 'No'">
                      {{ producto.prod_PagaImpuesto }}
                    </span>
                  </td>
                  <td>
                    <span *ngIf="producto.prov_NombreEmpresa; else sinProveedor">
                      {{ producto.prov_NombreEmpresa }}
                    </span>
                    <ng-template #sinProveedor>
                      <span class="text-muted">N/A</span>
                    </ng-template>
                  </td>
                  <td class="text-center">
                    <small class="text-muted">
                      {{ producto.prod_FechaCreacion | date:'dd/MM/yyyy' }}
                    </small>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Resumen estadístico -->
          <div class="row mt-4">
            <div class="col-md-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">
                    <i class="fas fa-chart-pie"></i> Resumen Estadístico
                  </h6>
                  <div class="row">
                    <div class="col-md-3">
                      <div class="text-center">
                        <div class="h4 text-primary">{{ productos.length }}</div>
                        <div class="text-muted">Total Productos</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="text-center">
                        <div class="h4 text-success">{{ calcularPromedioPrecios() | currency:'HNL':'symbol':'1.2-2' }}</div>
                        <div class="text-muted">Precio Promedio</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="text-center">
                        <div class="h4 text-info">{{ contarProductosConImpuesto() }}</div>
                        <div class="text-muted">Con Impuesto</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="text-center">
                        <div class="h4 text-warning">{{ contarMarcasUnicas() }}</div>
                        <div class="text-muted">Marcas Únicas</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensaje cuando no hay datos -->
  <div *ngIf="productos.length === 0 && !mostrarOverlayCarga" class="text-center">
    <div class="card">
      <div class="card-body">
        <div class="py-5">
          <i class="fas fa-search fa-3x text-muted mb-3"></i>
          <h4 class="text-muted">No se encontraron productos</h4>
          <p class="text-muted">
            No se encontraron productos con los filtros especificados. 
            Intente modificar los criterios de búsqueda.
          </p>
          <button 
            type="button" 
            class="btn btn-primary" 
            (click)="limpiarFiltros()">
            <i class="fas fa-refresh"></i> Limpiar Filtros
          </button>
        </div>
      </div>
    </div>
  </div>
</div>